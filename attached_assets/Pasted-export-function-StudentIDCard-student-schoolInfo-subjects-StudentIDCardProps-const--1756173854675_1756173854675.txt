export function StudentIDCard({ student, schoolInfo, subjects = [] }: StudentIDCardProps) {
  const [qrCodeImage, setQrCodeImage] = useState<string>('');
  const [isGenerating, setIsGenerating] = useState(false);

  const generateQRCodeData = () => `${student.type}:${student.id}:${schoolInfo.id}:verified`;

  const getSubjectNames = () => {
    if (!student.selectedSubjects?.length) return [];
    return student.selectedSubjects.map(id => {
      const subject = subjects.find(s => s.id.toString() === id);
      return subject ? subject.nameAr : `Ù…Ø§Ø¯Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ© (${id})`;
    });
  };

  useEffect(() => {
    const generateQRCode = async () => {
      setIsGenerating(true);
      try {
        const qrData = generateQRCodeData();
        const qrImage = await QRCode.toDataURL(qrData, {
          width: 150,
          margin: 2,
          color: { dark: '#000000', light: '#FFFFFF' },
        });
        setQrCodeImage(qrImage);
      } catch (error) {
        console.error('Error generating QR code:', error);
      } finally {
        setIsGenerating(false);
      }
    };
    generateQRCode();
  }, [student.id, student.type, schoolInfo.id]);

  const downloadIDCard = async () => {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    if (!ctx) return;

    canvas.width = 600;
    canvas.height = 350;

    // Load Noto Arabic font
    const font = new FontFace(
      'NotoArabic',
      'url(https://fonts.gstatic.com/s/notosansarabic/v17/3q2b8AJk6y2izaplaR2gLA.woff2)'
    );
    await font.load();
    document.fonts.add(font);
    ctx.font = '16px NotoArabic';
    ctx.direction = 'rtl';

    // Rounded card background
    const radius = 20;
    ctx.fillStyle = '#ffffff';
    ctx.beginPath();
    ctx.moveTo(radius, 0);
    ctx.lineTo(canvas.width - radius, 0);
    ctx.quadraticCurveTo(canvas.width, 0, canvas.width, radius);
    ctx.lineTo(canvas.width, canvas.height - radius);
    ctx.quadraticCurveTo(canvas.width, canvas.height, canvas.width - radius, canvas.height);
    ctx.lineTo(radius, canvas.height);
    ctx.quadraticCurveTo(0, canvas.height, 0, canvas.height - radius);
    ctx.lineTo(0, radius);
    ctx.quadraticCurveTo(0, 0, radius, 0);
    ctx.closePath();
    ctx.fill();

    // Gradient header
    const headerGradient = ctx.createLinearGradient(0, 0, canvas.width, 0);
    headerGradient.addColorStop(0, '#2563eb');
    headerGradient.addColorStop(1, '#3b82f6');
    ctx.fillStyle = headerGradient;
    ctx.fillRect(0, 0, canvas.width, 60);

    // School name
    ctx.fillStyle = '#fff';
    ctx.textAlign = 'center';
    ctx.font = 'bold 20px NotoArabic';
    ctx.fillText(schoolInfo?.name || 'Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©', canvas.width / 2, 28);
    ctx.font = '14px NotoArabic';
    ctx.fillText('Ø¨Ø·Ø§Ù‚Ø© Ù‡ÙˆÙŠØ© Ø§Ù„Ø·Ø§Ù„Ø¨', canvas.width / 2, 48);

    // Profile photo
    const photoX = 30;
    const photoY = 90;
    const photoSize = 80;
    ctx.fillStyle = '#f3f4f6';
    ctx.beginPath();
    ctx.arc(photoX + photoSize / 2, photoY + photoSize / 2, photoSize / 2, 0, 2 * Math.PI);
    ctx.fill();
    ctx.shadowColor = 'rgba(0,0,0,0.15)';
    ctx.shadowBlur = 5;

    const drawCardDetails = () => {
      const rightX = canvas.width - 30;

      // Student name
      ctx.textAlign = 'right';
      ctx.shadowBlur = 0;
      ctx.fillStyle = '#1f2937';
      ctx.font = 'bold 18px NotoArabic';
      ctx.fillText(student.name, rightX, 110);

      // Student type badge (rounded)
      const typeText = student.type === 'student' ? 'Ø·Ø§Ù„Ø¨' : 'Ø·ÙÙ„';
      const badgeWidth = ctx.measureText(typeText).width + 16;
      ctx.fillStyle = '#2563eb';
      ctx.beginPath();
      ctx.roundRect(rightX - badgeWidth, 95, badgeWidth, 24, 12);
      ctx.fill();
      ctx.fillStyle = '#fff';
      ctx.font = 'bold 12px NotoArabic';
      ctx.textAlign = 'center';
      ctx.fillText(typeText, rightX - badgeWidth / 2, 112);

      // Education level
      ctx.textAlign = 'right';
      ctx.fillStyle = '#6b7280';
      ctx.font = '12px NotoArabic';
      ctx.fillText('Ø§Ù„Ù…Ø³ØªÙˆÙ‰', rightX, 140);
      ctx.fillStyle = '#1f2937';
      ctx.font = 'bold 14px NotoArabic';
      ctx.fillText(formatEducationLevel(student.educationLevel, student.grade), rightX, 160);

      // Student ID
      ctx.fillStyle = '#6b7280';
      ctx.font = '12px NotoArabic';
      ctx.fillText('Ø§Ù„Ø±Ù‚Ù…', rightX - 150, 140);
      ctx.fillStyle = '#2563eb';
      ctx.font = 'bold 14px NotoArabic';
      ctx.fillText(`#${student.id}`, rightX - 150, 160);

      // Subjects
      const subjectNames = getSubjectNames();
      if (subjectNames.length > 0) {
        ctx.fillStyle = '#6b7280';
        ctx.font = '12px NotoArabic';
        ctx.fillText('Ø§Ù„Ù…ÙˆØ§Ø¯', rightX, 185);
        ctx.fillStyle = '#374151';
        ctx.font = '12px NotoArabic';
        ctx.fillText(subjectNames.slice(0, 3).join(' â€¢ '), rightX, 205);
        if (subjectNames.length > 3) {
          ctx.fillStyle = '#2563eb';
          ctx.fillText(`Ùˆ ${subjectNames.length - 3} Ø£Ø®Ø±Ù‰`, rightX, 225);
        }
      }

      // QR code (rounded)
      const qrX = 30;
      const qrY = 190;
      const qrSize = 90;
      ctx.fillStyle = '#fff';
      ctx.beginPath();
      ctx.roundRect(qrX, qrY, qrSize, qrSize, 12);
      ctx.fill();
      ctx.strokeStyle = '#d1d5db';
      ctx.strokeRect(qrX, qrY, qrSize, qrSize);

      if (qrCodeImage) {
        const qrImg = new Image();
        qrImg.onload = () => {
          ctx.drawImage(qrImg, qrX + 5, qrY + 5, qrSize - 10, qrSize - 10);
          downloadCanvas();
        };
        qrImg.src = qrCodeImage;
      } else {
        ctx.fillStyle = '#9ca3af';
        ctx.font = '14px NotoArabic';
        ctx.textAlign = 'center';
        ctx.fillText('QR', qrX + qrSize / 2, qrY + qrSize / 1.7);
        downloadCanvas();
      }
    };

    if (student.profilePicture) {
      const img = new Image();
      img.onload = () => {
        ctx.save();
        ctx.beginPath();
        ctx.arc(photoX + photoSize / 2, photoY + photoSize / 2, photoSize / 2, 0, 2 * Math.PI);
        ctx.clip();
        ctx.drawImage(img, photoX, photoY, photoSize, photoSize);
        ctx.restore();
        drawCardDetails();
      };
      img.src = student.profilePicture;
    } else {
      ctx.fillStyle = '#9ca3af';
      ctx.font = '36px NotoArabic';
      ctx.textAlign = 'center';
      ctx.fillText('ðŸ‘¤', photoX + photoSize / 2, photoY + photoSize / 1.5);
      drawCardDetails();
    }

    function downloadCanvas() {
      const link = document.createElement('a');
      link.download = `student_id_${student.name.replace(/\s+/g, '_')}.png`;
      link.href = canvas.toDataURL('image/png', 0.9);
      link.click();
    }
  };

  return (
    <button onClick={downloadIDCard} disabled={isGenerating}>
      {isGenerating ? 'Generating...' : 'Download ID Card'}
    </button>
  );
}
